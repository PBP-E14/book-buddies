{% extends "base.html" %}
{% load static %}

{% block content %}
<html>
    <header>
        <style>
            .content {
                background-color:#FFFFFF; 
                color:black; 
                padding-inline: 30px; 
                padding-block: 20px;
            }
    
            table {
                border-collapse: collapse;
                width: 100%;
            }

            .table-row-button {
                cursor: pointer;
                background-color: white;
            }

            .table-row-button:hover {
                background-color: lightgray;
            }
    
            td {
                border-block: 1px solid gray;
                padding: 8px;
            }
    
            #reply-info {
                text-align: center;
                color: gray;
            }
    
            h6 {
                color: grey;
            }

            #date {
                color: grey;
                text-align: end;
            }
    
            .add-forum-btn {
                align-items: center;
            }
        </style>
    </header>
    <body>
        <div class="content wrapper">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                  <li class="breadcrumb-item"><a href="{% url 'back_to_homepage' %}">Home</a></li>
                  <li class="breadcrumb-item active" aria-current="page">Forum List</li>
                </ol>
            </nav>
            <div id="forum_table"></div>
        </div>

        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header" style="background-color: lightblue;">
                        <h1 class="modal-title fs-5" id="exampleModalLabel">Add New Forum</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="button_close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="form" onsubmit="return false;">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="name" class="col-form-label">Title:</label>
                                <input type="text" class="form-control form-color" id="title" name="title"></input>
                            </div>
                            <div class="mb-3">
                                <label for="description" class="col-form-label">Content:</label>
                                <textarea class="form-control form-color" id="content" name="content" style="height: 300px;"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" id="button_close" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-success" id="button_add" data-bs-dismiss="modal">Add Forum</button>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>

<script>
    async function getForums() {
        return fetch("{% url 'get_forum_json' %}").then((res) => res.json())
    }

    async function getUsers() {
        return fetch("{% url 'get_user_json' %}").then((res) => res.json())
    }

    async function refreshForums() {
        document.getElementById("forum_table").innerHTML = ""
        const forums = await getForums()
        const users = await getUsers()
        let htmlString = ``
        if (forums.length > 0) {
            htmlString += `
                <h3>Forum Discussion</h3>
                <table>
            `
            forums.forEach((forum) => {
                var forumUser = `${forum.fields.user}`
                var username = ``
                users.forEach((thisUser) => {
                    if (thisUser.pk == forumUser) {
                        username += `${thisUser.fields.username}`
                    }
                })
                htmlString += `
                <tr class="table-row-button" onclick ="window.location='read_forum/${forum.pk}/';">
                    <td id="reply-info">
                        <p>Reply 
                        <br>${forum.fields.total_reply}
                        </p>
                    </td>
                    <td>
                        <h5>${forum.fields.title}</h5>
                        <h6>Posted by ${username} on ${forum.fields.created_at}</h6>
                `
                if (forum.fields.content.length > 300) {
                    var slicedContent = `${forum.fields.content}`.slice(0,300)
                    htmlString += `
                        <p>${slicedContent}...</p>
                    `
                } else {
                    htmlString += `
                        <p>${forum.fields.content}</p>
                    `
                }
                htmlString += `
                    </td>
                </tr>
                `
            })
            htmlString += `
                </table>
                <div class="text-center">
                    <button type="button" class="btn btn-outline-primary btn-lg" data-bs-toggle="modal" data-bs-target="#exampleModal" style="margin-block-start: 15px;">
                        Add Forum
                    </button>
                </div>
            `
        } else {
            htmlString += `
                <div class="text-center">
                    <h3>Belum ada forum yang di post.</h3>
                    <button type="button" class="btn btn-outline-primary btn-lg" data-bs-toggle="modal" data-bs-target="#exampleModal" style="margin-block-start: 15px;">
                        Tambah Forum
                    </button>
                </div>
            `
        }

        document.getElementById("forum_table").innerHTML = htmlString
    }

    refreshForums()

    function addForum() {
        fetch("{% url 'add_forum_ajax' %}", {
            method: "POST",
            body: new FormData(document.querySelector('#form'))
        }).then(refreshForums)

        document.getElementById("form").reset()
        return false
    }

    function closeModal() {
        document.getElementById("form").reset()
        return false
    }

    document.getElementById("button_add").onclick = addForum
    document.getElementById("button_close").onclick = closeModal
</script>
{% endblock %}